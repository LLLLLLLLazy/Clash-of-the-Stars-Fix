# 群星之争测试版

## AI优化详细说明（虫族方向）

### 1. 优化范围与目标
- 本轮AI优化主要覆盖：`AI敌人操作虫族`。
- 优化目标：
  - 缩短低级期，提前进入中高阶节奏。
  - 减少低级单位的无效消耗与“持续送兵”。
  - 增加“屯兵 -> 爆发”的波次进攻行为。
  - 在保持进攻强度的前提下，降低高频触发造成的CPU压力。

### 2. 全局AI节奏系统（`-[AI+]-/AI系统.ini`）

#### 2.1 阶段标签时点
- `开端{I}`：`时点=180`
- `战隙{I}`：`时点=260`（由300提前）
- `中刻{I}`：`时点=390`（由450提前）
- `后界{I}`：`时点=1200`

#### 2.2 战术节拍（屯兵/爆发）
- 新增全局资源：`战术节拍`。
- 新增全局标签：`AI屯兵`、`AI爆发`。
- 节拍切换时点：

| 节拍序号 | 时点 | 状态 |
| --- | --- | --- |
| 1 | 205 | 屯兵 |
| 2 | 245 | 爆发 |
| 3 | 300 | 屯兵 |
| 4 | 340 | 爆发 |
| 5 | 405 | 屯兵 |
| 6 | 450 | 爆发 |
| 7 | 560 | 屯兵 |
| 8 | 620 | 爆发 |
| 9 | 760 | 屯兵 |
| 10 | 830 | 爆发 |

- 防守打断：
  - 当处于`AI屯兵`且`700`范围内敌军`>3`时，强制切换到`AI爆发`。

#### 2.3 风险态势标签
- 新增“家危/家安”双向切换：
  - `1000`范围敌军`>1`加`家危`。
  - `1000`范围敌军`<2`移除`家危`。

#### 2.4 关闭清理增强
- AI关闭时会清理更多全局标签，避免残局污染下一局：
  - 包含`AI屯兵`、`AI爆发`、`攻路受阻`、`攻路2确定`、`开端计攻2`等。
- 同步重置：`时点`与`战术节拍`。

### 3. 攻路系统优化（`寻攻路筛选.ini` / `寻攻路否.ini`）

#### 3.1 识别目标扩展
- 攻路判定由仅识别`地震塔T2`扩展为同时识别：
  - `地震塔T2`
  - `地震T2升级中`

#### 3.2 受阻状态机
- 新增全局标签：`攻路受阻`。
- 触发逻辑：
  - 探针检测到关键目标阻断 -> 标记`攻路受阻`并切换`寻攻路否`分支。
  - 路径成功确定后 -> 添加`攻路2确定`并清除`攻路受阻`。

#### 3.3 自动重试与容错
- 在`AI系统.ini`中新增受阻重试：
  - 满足`攻路受阻 + 开端计攻2 + 未攻路2确定`且无筛选探针时，每`12s`重试一次。
- 在探针中新增阻挡计数`AI阻挡`：
  - 卡住累计到阈值时强制触发再检测。
- 新增超时清理：
  - `寻攻路筛选`超时`60s`销毁。
  - `寻攻路否`超时`35s`销毁。

#### 3.4 频率控制
- `寻攻路筛选`冷却设为`0.1s`。
- `寻攻路否`冷却设为`0.11s`。
- 目标：保持探针响应同时避免0.01s级高频轮询。

### 4. 虫族经济与产能策略（建筑侧）

#### 4.1 母巢（`-虫族-/建筑虫/建筑_母巢/母巢.ini`）
- AI建造虫征集：
  - 仅在未进入`战隙{I}`时大量补建造虫。
- AI蚊子征集：
  - 增加`not AI屯兵`限制，屯兵期停止低级骚扰刷兵。
  - 单次花费由批量改为更保守批次（单次`380`，且要求队列空闲）。

#### 4.2 母巢T2（`-虫族-/建筑虫/建筑_母巢/母巢T2.ini`）
- 战隙期建造虫征集增加`not AI爆发`，爆发期让资源优先给重型单位。
- 两栖蝇与收成者征集保留数量与资源阈值判定。
- 新增爆发重型征集：
  - 条件：`AI爆发 + 中刻{I} + 资金12000 + 修复点不足`。
  - 行为：连续征集双收成者，提升中后期质量单位比重。

#### 4.3 虫巢（`-虫族-/建筑虫/建筑_虫巢/虫巢.ini`）
- 一号地巢开局批量噬咬虫数量从更激进方案下调到4只，降低早期低效堆量。
- 升级触发前置到`开端{I}`后半段，并结合`AI屯兵`或`战隙{I}`执行，减少盲升。

#### 4.4 虫巢T2（`-虫族-/建筑虫/建筑_虫巢/虫巢T2.ini`）
- 战隙/中刻的建造虫补充均加`not AI爆发`限制。
- 中刻补建造虫新增数量上限判断，防止多建筑重复补工导致浪费。

#### 4.5 飞虫地巢（`-虫族-/建筑虫/建筑_虫巢/飞虫地巢.ini`）
- 基础飞虫（bugWasp）可见条件新增`not AI屯兵`。
- 升级触发改为：`开端{I}`后，满足`AI屯兵`或`战隙{I}`时推进。

#### 4.6 飞虫地巢T2（`-虫族-/建筑虫/建筑_虫巢/飞虫地巢T2.ini`）
- 保留中刻常规高空编队（捕猎虫/音波）逻辑。
- 新增爆发高空压制：
  - 条件：`AI爆发 + 中刻{I} + 资金5000 + 队列空闲`
  - 行为：批量空军压制，形成波次制空。

### 5. 虫族作战行为优化（单位侧）

#### 5.1 蚊子（`-虫族-/空虫/空_蚊子/蚊子.ini`）
- 常规攻击、家危反击、attackMove中点推进均增加`not AI屯兵`条件。
- 新增两个战术动作：
  - `AI屯兵集结`：守基地（guard）
  - `AI爆发突击`：attackMove冲敌基地

#### 5.2 飞虫（`-虫族-/空虫/空_飞虫/bug_wasp.ini`）
- 初队进攻与中点推进增加`not AI屯兵`。
- 新增屯兵/爆发动作，行为与蚊子一致但持续时长更长。
- 集群进攻也受`not AI屯兵`约束，避免屯兵期提前出击。

#### 5.3 战斗虫（`-虫族-/陆虫/陆_战斗虫/bug_ranged.ini`）
- 集群进攻动作增加`not AI屯兵`。
- 新增屯兵集结动作（基地防守集合）。

#### 5.4 群虫（`-虫族-/陆虫/陆_群虫/群虫.ini`）
- 新增`AI屯兵集结`与`AI爆发突击`完整波次动作。
- 多个主动进攻触发增加`not AI屯兵`限制。
- 保留针对`地震T2升级中`的前锋/跟虫特殊攻坚逻辑。
- 保留无效攻击回收与重置流程，减少单位空转。

### 6. 性能与稳定性修复
- `numberOfUnitsInTeam`范围限制修复：
  - `withinRange=1200` -> `withinRange=1000`（引擎上限）。
- 路径探针冷却上调到`0.1s`级，降低CPU压力。
- 说明：
  - `autoTriggerCooldownTime`过低（如`0.01s`）在部分版本下即使写了`allowDangerousHighCPU`也可能被判定不通过。
  - 大规模单位建议维持`>=0.1s`，否则容易出现加载报错或帧耗尖峰。

### 7. 当前状态
- 本轮AI行为优化重点仍是虫族。
- AI随机阵营池当前仍为：`铁锈`、`虫族`。

### 8. 后续迭代落地（新增）

#### 8.1 全局战术节奏动态化（`-[AI+]-/AI系统.ini`）
- 新增全局标签`AI延屯`与资源`延屯截止`，形成“受挫延屯 -> 恢复后再爆发”回路。
- 当处于`AI爆发`且出现`攻路受阻`或`家危`时，自动回切`AI屯兵`并延长屯兵时长。
- 当攻路已确定且兵力达标（`units>28`）时，允许提前切回`AI爆发`。
- 在`战隙{I}`与`后界{I}`阶段加入更主动的促攻阈值（`units>24` / `units>18`）。

#### 8.2 矿坑争夺与占区经营（`矿点定位.ini`、`bug_spore.ini`、`bug_fly.ini`）
- 矿点重新标记等待由`20s`缩短为`12s`，AI更快发现空矿点。
- 建造虫/建造飞虫的“造矿”并发上限提升，并绑定可用矿点条件，减少空跑。
- 新策略：`造矿时即护塔`。在`bug_spore.ini`地面建造虫中，矿坑建矿动作进行中即可触发防御建塔，不再只在被压后反应。
- 新增占领区建设链：
  - `占区防御建塔`
  - `占区恢复建池`
  - `占区兵营建巢`
- 占区建造沿用并强化建筑密度限制（自队/友队阈值），降低堵路概率。

#### 8.3 资源建筑自保（`虫矿.ini` ~ `虫矿T4.ini`）
- T1~T4资源提取器统一新增`AI矿坑防御`：
  - 近距敌军压矿时，若矿区缺塔则直接触发建塔。
  - 同时限制近距建筑数量，避免矿区防御挤占移动空间。

#### 8.4 全单位战术行为扩展（`-虫族-/all-units.template`）
- 新增残血撤退机制：
  - 血量`<20%`进入`AI残血撤退`。
  - 血量`>55%`自动解除撤退标记。
- 新增防空支援与地面支援：
  - 被空军攻击且自身未有效还击时，向周边友军广播支援请求。
  - 被地面远程持续拉扯时，触发地面支援响应。
- 新增集火机制：
  - 进攻/防守状态优先压制高价值目标（基地、母巢、终焉虫巢、高阶炮塔等）。
  - 通过消息广播带动周边部队同目标协同攻击。
- 新增屯兵驻点逻辑：
  - 安全时优先在`资源提取器`附近屯兵。
  - 矿区受压或无安全矿区时回基地屯兵。
- 新增前线锚点与薄弱点进攻：
  - 战隙期识别敌方薄防区域并标记`AI前线锚点`。
  - 爆发期优先打击敌方矿区/生产建筑/基地，减少无效硬冲。

#### 8.5 中后期产能倾斜与高阶优先
- `母巢.ini`、`虫巢T2.ini`、`双邪虫巢.ini`：
  - 中后期锁定部分低级单位生产位，减少低级兵持续堆量。
- `筑炼者.ini`：
  - `终焉虫巢`触发由超后期前移到`中刻{I}`可建，并下调触发资金门槛到中后期可达区间。
- `母巢T2.ini`：
  - 升级到T2后自动随机快捷分支（`衍黎`/`狂猎`）并防重复选择。
  - 屯兵期新增重型单征集，避免“只屯不补高阶”。
- `普拉克勒斯.ini`：
  - `腐蚀之意`与`衍黎生长`加入`ai_isHighPriority: true`。
  - 腐蚀资源足够时，AI主动提高上述选项优先级并自动触发。
  - 新增分支随机选择，减少AI卡分支。
- `治愈池.ini`：
  - 补充`治愈池`标签，提升占区补给建筑识别准确性。

#### 8.6 联动兼容与报错规避（`皎月升起.ini` + 全模板）
- `皎月升起.ini`开场即标记`皎红`阵营标签，避免被虫族通用AI逻辑接管。
- 通用AI新增逻辑均增加`not self.globalTeamTags(includes='皎红')`隔离条件，避免影响皎洁之红联动。
- 规避“key was not used”与超低冷却触发类报错风险，提升加载稳定性。

## 关键修改文件
- `-[AI+]-/AI系统.ini`
- `-[AI+]-/矿点定位.ini`
- `-[AI+]-/寻攻路筛选.ini`
- `-[AI+]-/寻攻路否.ini`
- `-[AI+]-/漂浮灵控制.ini`
- `-虫族-/all-units.template`
- `-虫族-/-皎洁之红联动-/皎洁之红出场/皎月升起.ini`
- `-虫族-/建筑虫/建筑_母巢/母巢.ini`
- `-虫族-/建筑虫/建筑_母巢/母巢T2.ini`
- `-虫族-/建筑虫/建筑_普拉克勒斯/普拉克勒斯.ini`
- `-虫族-/建筑虫/建筑_治愈池/治愈池.ini`
- `-虫族-/建筑虫/建筑_虫巢/虫巢.ini`
- `-虫族-/建筑虫/建筑_虫巢/虫巢T2.ini`
- `-虫族-/建筑虫/建筑_虫巢/双邪虫巢.ini`
- `-虫族-/建筑虫/建筑_虫巢/飞虫地巢.ini`
- `-虫族-/建筑虫/建筑_虫巢/飞虫地巢T2.ini`
- `-虫族-/建筑虫/建筑_虫族资源抽取器/虫矿.ini`
- `-虫族-/建筑虫/建筑_虫族资源抽取器/虫矿T2.ini`
- `-虫族-/建筑虫/建筑_虫族资源抽取器/虫矿T3.ini`
- `-虫族-/建筑虫/建筑_虫族资源抽取器/虫矿T4.ini`
- `-虫族-/空虫/空_建造飞虫/bug_fly.ini`
- `-虫族-/空虫/空_蚊子/蚊子.ini`
- `-虫族-/空虫/空_飞虫/bug_wasp.ini`
- `-虫族-/陆虫/陆T2_筑练者/筑炼者.ini`
- `-虫族-/陆虫/陆_建造虫/bug_spore.ini`
- `-虫族-/陆虫/陆_战斗虫/bug_ranged.ini`
- `-虫族-/陆虫/陆_群虫/群虫.ini`
