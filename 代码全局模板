#制作辅助

[template_代码全局变量]
#[template]与全局变量不会减慢mod加载速度

@global ConvertUpdate1: globalSearchForFirstUnit(withTag='单位系统', relation='own')
@global ConvertUpdate2: 数据更新
@global DelayedConvertUpdate: 数据延时更新


@global addV:
@global HalfCorrosion: """
(numberOfUnitsInTeam(withTag='腐蚀蔓延')
+self.numberOfUnitsInAllyNotOwnTeam(withTag='腐蚀蔓延')
-self.numberOfUnitsInAllyNotOwnTeam(withTag='主母巢')
>5
 and numberOfUnitsInTeam(withTag='腐蚀蔓延')
+self.numberOfUnitsInAllyNotOwnTeam(withTag='腐蚀蔓延')
-self.numberOfUnitsInAllyNotOwnTeam(withTag='主母巢')
>numberOfUnitsInAllTeams(withTag='资源池')/max(self.resource.玩家总数, 2))
"""
@global HalfCorrosionLimit: and self.globalTeamTags(includes='首次半腐')

@global CompleteCorrosion: """
(numberOfUnitsInTeam(withTag='腐蚀蔓延')
+self.numberOfUnitsInAllyNotOwnTeam(withTag='腐蚀蔓延')
-self.numberOfUnitsInAllyNotOwnTeam(withTag='主母巢')
>10
 and numberOfUnitsInTeam(withTag='腐蚀蔓延')
+self.numberOfUnitsInAllyNotOwnTeam(withTag='腐蚀蔓延')
-self.numberOfUnitsInAllyNotOwnTeam(withTag='主母巢')
>numberOfUnitsInAllTeams(withTag='资源池')/max(self.resource.玩家总数, 2)*2 and numberOfUnitsInTeam(withTag='星核')+self.numberOfUnitsInAllyNotOwnTeam(withTag='星核')>0)
"""
@global CompleteCorrosionLimit: and self.globalTeamTags(includes='扩散达成')

@global CompleteCorrosionB: """
(numberOfUnitsInTeam(withTag='腐蚀蔓延')
+self.numberOfUnitsInAllyNotOwnTeam(withTag='腐蚀蔓延')
-self.numberOfUnitsInAllyNotOwnTeam(withTag='主母巢')
>7
 and numberOfUnitsInTeam(withTag='腐蚀蔓延')
+self.numberOfUnitsInAllyNotOwnTeam(withTag='腐蚀蔓延')
-self.numberOfUnitsInAllyNotOwnTeam(withTag='主母巢')
>numberOfUnitsInAllTeams(withTag='资源池')/max(self.resource.玩家总数, 2)*2)
"""


@global DescriptionYanLi:-出场时会在附近产生3个虫塔\n-母巢附近每隔150s会生长一个虫塔\n-虫塔将逐渐生长以免费进行升级\n-虫族资源抽取器在升级完成时附近会生长一个虫塔\n-虫族资源抽取器一定范围内的己方单位将加速回血\n-随腐蚀蔓延阶段突破后所有虫族资源抽取器附近每隔150s会再次生长一个虫塔\n-由衍黎能力生长的虫塔|墙会具有野性: \n(自我回收不退还资源/完全腐蚀后可退还25%资源|10%价格的腐蚀)\n-母巢生长虫塔时有可能在腐蚀地脉中扎根赛法草\n-赛法草可协助腐蚀蔓延和复生母巢\n-腐蚀后普拉克勒斯解锁攻击与[枝繁叶茂]\n(温馨提示:腐蚀蔓延简介可在母巢行动查看)
@global DescriptionKuangLie:-大部分腐蚀后单位击杀敌方单位将增长腐蚀\n-腐蚀后单位在死亡时将返还其造价25%的资金与腐蚀\n-虫族资源抽取器能够孕育部分低级虫族且允许转换腐蚀模式\n-母巢没有攻击能力但死亡后爆裂出尖刺\n-虫巢将少量增长腐蚀\n-随腐蚀蔓延阶段突破后腐蚀单位击杀增长更多腐蚀量\n-两个腐蚀阶段的首次突破会进入20|40s狂猎时刻并获得额外腐蚀\n-狂猎时刻下所有资源池会产生微噬虫并提升虫族移速和生产速度\n-狂猎时刻下所有虫族单位击杀增长目标[价格25%|腐蚀80%]的腐蚀\n-腐蚀后普拉克勒斯获得护盾并解锁资源兑换与[仙肴圣餐]\n(温馨提示:腐蚀蔓延简介可在母巢行动查看)

#- - - - - - - - - - - - - - - -
[template_腐蚀蔓延简介]
@define descriptionPrefix:
description: ${descriptionPrefix}-同时拥有数个可协助[腐蚀蔓延]的单位后触发\n-拥有5个腐蚀蔓延单位且数量达到[地图总矿÷玩家数量]时将母巢升级为T2\n-拥有10个且数量达到[地图总矿÷玩家数量*2]并拥有1个星核时将所有T4矿转化为母巢T2\n-随进度突破会产生1|3个损失资源但能揭开迷雾的普拉克勒斯之眼\n-达成腐蚀蔓延中段|扩散条件后可在母巢决定完成蔓延\n-来自盟友的单位也可协助腐蚀蔓延\n(腐蚀蔓延:[母巢 | 虫族资源抽取器T4 | 邪恶之卵 | 赛法草])\n(温馨提示:养育高级战力的终焉虫巢由T2虫巢的筑练者所建造)\n-腐蚀蔓延进度: (%{min( (numberOfUnitsInTeam(withTag='腐蚀蔓延')+self.numberOfUnitsInAllyNotOwnTeam(withTag='腐蚀蔓延')-self.numberOfUnitsInAllyNotOwnTeam(withTag='主母巢')) / max(11, numberOfUnitsInAllTeams(withTag='资源池')/max(self.resource.玩家总数, 2)*2) * 100, select(numberOfUnitsInTeam(withTag='星核')+self.numberOfUnitsInAllyNotOwnTeam(withTag='星核')<=0, 99.99, 100))}%%{select(numberOfUnitsInTeam(withTag='星核')+self.numberOfUnitsInAllyNotOwnTeam(withTag='星核')<=0, '|缺少星核', '')})

#- - - - - - - - - - - - - - - -
[template_水下出厂]
autoTriggerOnEvent: created
requireConditional: if customTarget1.tags(includes='水下工厂')
setHeight: customTarget1.height

#- - - - - - - - - - - - - - - -
[template_生存防御巩固]
isVisible: if numberOfUnitsInAllTeams(withTag='生存模式')>0 and self.resource.起始基地>0
price: 5000
id: ${section.text}
text: 防御巩固
description: -生存模式特供 \n-提升2500血量 \n-可无限升级
displayType: upgrade
buildSpeed: ${66.6*buildMultiplier}s
@define buildMultiplier: 1
pos: 1.3
iconImage: 六边形巩.png
iconExtraImage: 灰升级.png
iconExtraColor: #AAFFFFFF
setUnitMemory: 属性[14]=memory.属性[14]+${strengthen}
@define strengthen: 2500
alsoTriggerAction: 属性变化
spawnEffects: 生存防御巩固形

[template_生存防御巩固形]
life: 60
fadeInTime: 8
image: 六边形巩.png
scaleFrom: 3
scaleTo: 3

#- - - - - - - - - - - - - - - -
[template_狂猎击杀]
isActive: false
isVisible: if self.globalTeamTags(includes='狂猎') and not (${HalfCorrosion} ${HalfCorrosionLimit}) ${addV}
requireConditional: if self.globalTeamTags(includes='狂猎') and not (${HalfCorrosion} ${HalfCorrosionLimit}) and not eventSource.self.tags(includes="召唤物")
autoTriggerOnEvent: killedAnyUnit
id: 狂猎击杀
text: 狂猎
description: -击杀目标增长20腐蚀
pos: 0
displayType: infoOnlyStockpile
buildSpeed: 0s
addResources: 腐蚀=20
isAlsoViewableByAllies: true

[template_狂猎击杀2]
isActive: false
isVisible: if (${HalfCorrosion} ${HalfCorrosionLimit}) and self.globalTeamTags(includes='狂猎') ${addV}
requireConditional: if (${HalfCorrosion} ${HalfCorrosionLimit}) and self.globalTeamTags(includes='狂猎') and not eventSource.self.tags(includes="召唤物")
autoTriggerOnEvent: killedAnyUnit
id: 狂猎击杀2
text: 狂猎
description: -击杀增长20+(目标价格2%)的腐蚀
pos: 0
displayType: infoOnlyStockpile
buildSpeed: 0s
addResourcesWithLogic: 腐蚀=20+eventSource.priceCredits*0.02
isAlsoViewableByAllies: true

#- - - - - - - - - - - - - - - -
[template_生产随移动工厂前进]
autoTriggerOnEvent: completeAndActive
requireConditional: if customTarget1.tags(includes='移动工厂单位') and customTarget1.hasActiveWaypoint(type='move')
addWaypoint_type: move
addWaypoint_target_fromReference: customTarget1.activeWaypointTarget

[template_生产跟随移动工厂]
autoTriggerOnEvent: completeAndActive
requireConditional: if customTarget1.tags(includes='移动工厂单位')
addWaypoint_type: guard
addWaypoint_target_fromReference: customTarget1

#- - - - - - - - - - - - - - - -
[template_一次性建造优化检测]
autoTriggerOnEvent: newWaypointGivenByPlayer
requireConditional: if self.hasActiveWaypoint(type='build')
takeResources_includeUnitsWithinRange: 1000
takeResources_excludeUnitsWithoutTags: 一次性建造
takeResources_includeUnitsWithinRange_team: own
takeResources_triggerActionForEach: 一次性建造优化
takeResources_searchOnly: true

[template_一次性建造优化]
requireConditional: if thisActionTarget!=self and distanceBetween(thisActionTarget.activeWaypointTarget, self.activeWaypointTarget)<10 and thisActionTarget.self.hasActiveWaypoint(type='build')
clearActiveWaypoint: true

#- - - - - - - - - - - - - - - -
[template_范围回收]
id: ${section.text}
text: 范围回收
description: -一键选择以回收指定位置80范围内的所有单位 \n -正在回收建筑时可选取建筑
displayType: action
buildSpeed: 0s
pos: 0

highPriorityQueue: true

@define turret: 1
fireTurretXAtGround: ${turret}
fireTurretXAtGround_count: 0
fireTurretXAtGround_showGuideDecals: 回收范围
setUnitMemory: 指定坐标=thisActionTarget

takeResources: 0
takeResources_maxUnits: 9999
takeResources_excludeUnitsWithoutTags: units
takeResources_includeUnitsWithinRange_team: own
takeResources_includeUnitsWithinRange: ${core.nanoRange}
takeResources_triggerActionForEach: 回收路径
takeResources_searchOnly: true

[template_回收路径]
requireConditional: if distanceBetween(memory.指定坐标, thisActionTarget)<=80 and (thisActionTarget.readUnitMemory("建筑", type='boolean')==false or activeWaypointTarget.readUnitMemory("建筑", type='boolean')==true and self.hasActiveWaypoint(type='reclaim'))
addWaypoint_type: reclaim
addWaypoint_target_fromReference: thisActionTarget

[template_无距范围回收]
@copyFromSection: template_范围回收
takeResources_includeUnitsWithinRange: 9999

[template_回收范围]
alwaysStartHeightAtZero: true
layer: inactive
image: 圆.png
imageScale: ${80/250}
alpha: 0.15
color: #FF0000
drawLineTo: self

#- - - - - - - - - - - - - - - -
[template_范围运输]
isActive: if not self.transportingCount(full=true)
id: ${section.text}
text: 范围运输
description: -一键选择运输指定位置120范围内的待命单位
buildSpeed: 0s
pos: 0

highPriorityQueue: true

@define turret: skill
fireTurretXAtGround: ${turret}
fireTurretXAtGround_count: 0
fireTurretXAtGround_showGuideDecals: 运输范围
setUnitMemory: 指定坐标=thisActionTarget

takeResources: 0
takeResources_maxUnits: 9999
takeResources_excludeUnitsWithoutTags: units
takeResources_includeUnitsWithinRange_team: own
takeResources_includeUnitsWithinRange: 9999
takeResources_triggerActionForEach: 运输路径
takeResources_searchOnly: true

clearActiveWaypoint: true

[template_运输路径]
requireConditional: if distanceBetween(memory.指定坐标, thisActionTarget)<=120 and not thisActionTarget.hasActiveWaypoint
addWaypoint_type: loadUp
addWaypoint_target_fromReference: thisActionTarget
sendMessageTo: select(thisActionTarget.tags(includes='不可控'), null, thisActionTarget)
sendMessageWithTags: 运输

[template_运输范围]
alwaysStartHeightAtZero: true
layer: inactive
image: ROOT:/素材/圆500.png
imageScale: ${120/250}
alpha: 0.15
color: #00FFFF
drawLineTo: self

#- - - - - - - - - - - - - - - -
[template_扩散移动点开]
isVisible: if not self.globalTeamTags(includes='扩散移动点')
displayType: action
pos: 10
id: ${section.text}
text: 扩散移动点
description: -开启后替换设置巡逻区效果 \n -以目标点为中心随机设定一个移动目的地 \n -指定距离越远扩散范围越大
buildSpeed: 0s
iconImage: SHARED:icon_off.png
allowMultipleInQueue: false
highPriorityQueue: true
ai_isDisabled: true
addGlobalTeamTags: 扩散移动点

[template_扩散移动点关]
@copyFromSection: template_扩散移动点开
isVisible: if self.globalTeamTags(includes='扩散移动点')
id: ${section.text}关
isGuiBlinking: true
iconImage: SHARED:icon_on.png
addGlobalTeamTags: IGNORE
removeGlobalTeamTags: 扩散移动点

[template_设置扩散移动点]
autoTriggerOnEvent: newWaypointGivenByPlayer
requireConditional: if self.numberOfQueuedWaypoints(type='patrol')>0 and self.globalTeamTags(includes='扩散移动点')
alsoTriggerAction: 清除当前非巡逻路径, 锁定扩散移动点

[template_清除当前非巡逻路径]
requireConditional: if not self.hasActiveWaypoint(type='patrol')
clearActiveWaypoint: true

[template_锁定扩散移动点]
addWaypoint_type: move
addWaypoint_prepend: true
addWaypoint_target_fromReference: """
activeWaypointTarget.getOffsetRelative(
x=rnd(0, self.id)/self.id*distanceBetween(self, activeWaypointTarget) - (distanceBetween(self, activeWaypointTarget)/2) * 0.5,
y=rnd(0, self.id)/self.id*distanceBetween(self, activeWaypointTarget) - (distanceBetween(self, activeWaypointTarget)/2) * 0.5)
"""
addWaypoint_triggerActionIfMatched: 执行扩散移动点

[template_执行扩散移动点]
addWaypoint_type: move
addWaypoint_prepend: true
addWaypoint_position_fromAction: true
clearAllWaypoints: true

#- - - - - - - - - - - - - - - -
[template_无延迟追击]
addWaypoint_type: attack
addWaypoint_maxTime: 0.1s
addWaypoint_prepend: true
addWaypoint_target_fromReference: activeWaypointTarget
addWaypoint_target_nearestUnit_team: enemy
addWaypoint_target_mapMustBeReachable: false
autoTrigger: if self.hasActiveWaypoint(type='attack') and activeWaypointTarget.hp>0 ${condition}
@define condition: and distanceBetween(self, activeWaypointTarget) < 250
[template_无延迟追击2]
@copyFromSection: template_无延迟追击
autoTrigger: if activeWaypointTarget==nullUnit and not self.hasActiveWaypoint(type="move") and attacking!=null ${condition}
addWaypoint_target_fromReference: attacking
@define condition: and distanceBetween(self, attacking) < 250

[template_无延迟追击B]
@copyFromSection: template_无延迟追击
@define condition: and distanceBetween(self, activeWaypointTarget) < 50

[template_无延迟追击B2]
@copyFromSection: template_无延迟追击2
@define condition: and distanceBetween(self, attacking) < 50

#- - - - - - - - - - - - - - - -
[template_浮动装甲减伤]
@define Limiting: 300
@define HighDamageReduction: 1

autoTriggerOnEvent: tookDamage
autoTrigger: if self.resource.受击前血量>self.hp
requireConditional: if self.resource.受击前血量>self.hp
setResourcesWithLogic:"""
受到伤害=self.resource.受击前血量-self.hp, 
受损量=self.resource.受损量+self.resource.受到伤害, 
hp=self.hp+(self.resource.受到伤害) * ( 1-1/(1+self.resource.受损量 / (${Limiting}+self.resource.受到伤害/${HighDamageReduction})) ),
受击前血量=self.hp
"""

#- - - - - - - - - - - - - - - -
[template_属性变化-附属]
sendMessageTo: attachment
sendMessageWithTags: 数据更新

#- - - - - - - - - - - - - - - -
[template_继承主单位攻击属性]
autoTriggerOnEvent: newMessage(withTag='数据更新')
setUnitMemory:"""
属性[2]=customTarget1.readUnitMemory("属性", type='float', index=2),
属性[3]=customTarget1.readUnitMemory("属性", type='float', index=3),
属性[5]=customTarget1.readUnitMemory("属性", type='float', index=5),
属性[18]=customTarget1.readUnitMemory("属性", type='float', index=18),
属性[20]=customTarget1.readUnitMemory("属性", type='float', index=20),
属性[55]=customTarget1.readUnitMemory("属性", type='float', index=55),
属性[41]=customTarget1.readUnitMemory("属性", type='float', index=41),
属性[40]=customTarget1.readUnitMemory("属性", type='float', index=40),
属性[19]=customTarget1.readUnitMemory("属性", type='float', index=19),
属性[21]=customTarget1.readUnitMemory("属性", type='float', index=21),
属性[42]=customTarget1.readUnitMemory("属性", type='float', index=42)
"""
alsoTriggerAction: 属性变化

#- - - - - - - - - - - - - - - -
[template_turret_skill]
x: 0
y: 0
invisible: true
canShoot: false
limitingRange: 9999
