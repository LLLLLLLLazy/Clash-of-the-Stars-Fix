
[core]
name: 虫族资源抽取器T4
displayDescription: -窃取地脉能源\n -只能建造在资源池上\n -缺失母巢时可构筑为母巢\n -腐蚀扩张
class: CustomUnitMetadata
price: 8600
maxHp: 2000
mass: 9000

tags: units, 虫族, 虫建筑, 腐蚀蔓延, 资源提取器

@define CorrosionMode: 0
generation_resources: 腐蚀=${1.25 + CorrosionMode}
generation_credits: 40
generation_delay: 40

fogOfWarSightRange: 18

techLevel: 1
buildSpeed: 0.002

radius: 20

isBio: true
isBug: true

isBuilding: true
isBuilder: true

placeOnlyOnResPool: true

selfRegenRate:0.1
selfBuildRate:0.002

softCollisionOnAll: 3

energyMax: 2

showActionsWithMixedSelectionIfOtherUnitsHaveTag:资源提取器

[hiddenAction_erosions]
requireConditional: if self.globalTeamTags(includes='衍黎')
autoTriggerOnEvent: created
autoTrigger: if self.customTimer(laterThanSeconds=60)
spawnEffects: custom:curewave
resetCustomTimer: true

[effect_curewave]
priority: critical
liveAfterAttachedDies: false
fadeOut: false
attachedToUnit: true
drawUnderUnits: true
image: SHARED:light_50.png
color: #AEFF00
life: 3660
scaleFrom: 7.5
scaleTo: 7.5
alpha: 0.1

[hiddenAction_狂猎]
autoTrigger:if self.globalTeamTags(includes='狂猎')
convertTo: 虫族资源抽取器T4[狂猎]
sendMessageTo: ${ConvertUpdate1}
sendMessageWithTags: ${ConvertUpdate2}

[hiddenAction_缺失母巢]
autoTrigger: if numberOfUnitsInTeam(withTag='母巢', lessThan=1, factoryQueue=true) and not self.globalTeamTags(includes='已设定缺失母巢')
setResourcesWithLogic: 缺失母巢=1
addGlobalTeamTags: 已设定缺失母巢

[action_Mothernest]
isVisible: if numberOfUnitsInTeam(withTag='母巢', lessThan=1, factoryQueue=true)
isActive: if numberOfUnitsInTeam(withTag='母巢复生', lessThan=1, factoryQueue=true)
text: 母巢
description: -虫群之心
descriptionAddUnitStats: ${section.convertTo}
displayType: upgrade
convertTo: 母巢
sendMessageTo: ${ConvertUpdate1}
sendMessageWithTags: ${ConvertUpdate2}
buildSpeed: 46.2s
pos: -2
price: 缺失母巢=1
setResourcesWithLogic: 缺失母巢=1
whenBuilding_triggerAction: AddTags
onlyOneUnitAtATime: true
canPlayerCancel: true
ai_isHighPriority: true
[hiddenAction_AddTags]
temporarilyAddTags: 母巢复生
[hiddenAction_resetTags]
autoTrigger: if self.tags(includes='母巢复生') and self.queueSize(empty=true)
temporarilyRemoveTags: 母巢复生

[action_erosion]
isActive: false
text: 腐蚀蔓延
description: -扩散……\n-腐蚀蔓延进度: (%{min( (numberOfUnitsInTeam(withTag='腐蚀蔓延')+self.numberOfUnitsInAllyNotOwnTeam(withTag='腐蚀蔓延')-self.numberOfUnitsInAllyNotOwnTeam(withTag='主母巢')) / max(11, numberOfUnitsInAllTeams(withTag='资源池')/max(self.resource.玩家总数, 2)*2) * 100, select(numberOfUnitsInTeam(withTag='星核')+self.numberOfUnitsInAllyNotOwnTeam(withTag='星核')<=0, 99.99, 100))}%%{select(numberOfUnitsInTeam(withTag='星核')+self.numberOfUnitsInAllyNotOwnTeam(withTag='星核')<=0, '|缺少星核', '')})
displayType: infoOnly
convertTo: 母巢T2
sendMessageTo: ${ConvertUpdate1}
sendMessageWithTags: ${ConvertUpdate2}
autoTrigger: if (${CompleteCorrosion} ${CompleteCorrosionLimit}) and numberOfUnitsInTeam(withTag='母巢', greaterThan=0)
addResources: hp=5000
isVisible: if numberOfUnitsInTeam(withTag='母巢', greaterThan=0)
buildSpeed: 0s
pos: -1

[global_resource_玩家总数]
displayName: 玩家总数

[action_trigger]
autoTrigger: if self.energy(greaterThan=0) and self.globalTeamTags(includes='衍黎')
addResources: energy=-1
fireTurretXAtGround: 1
fireTurretXAtGround_withOffset:0,0
fireTurretXAtGround_withProjectile: 1
isVisible: false

[action_trigger2]
autoTrigger: if self.globalTeamTags(includes='衍黎')
fireTurretXAtGround: 1
fireTurretXAtGround_withOffset:0,0
fireTurretXAtGround_withProjectile: 2
isVisible: false


[hiddenAction_顶点之处]
autoTrigger: if self.globalTeamTags(includes="顶点") and not self.tags(includes="顶点之处")
temporarilyAddTags: 顶点之处

[hiddenAction_落下顶点]
autoTrigger: if not self.globalTeamTags(includes="顶点") and self.tags(includes="顶点之处")
temporarilyRemoveTags: 顶点之处

[hiddenAction_AI矿坑防御]
autoTrigger: if self.globalTeamTags(includes='AI系统') and self.hasResources(900) and (numberOfUnitsInEnemyTeam(withTag='units', greaterThan=0, withinRange=420) or self.hasResources(credits=2200)) and not numberOfUnitsInTeam(withTag='炮塔', greaterThan=2, withinRange=280, incompleteBuildings=true) and self.numberOfUnitsInAllyNotOwnTeam(withTag='炮塔', lessThan=4, withinRange=280, incompleteBuildings=true) and numberOfUnitsInTeam(withTag='虫建筑', lessThan=6, withinRange=110, incompleteBuildings=true) and self.numberOfUnitsInAllyNotOwnTeam(withTag='虫建筑', lessThan=4, withinRange=110, incompleteBuildings=true)
addResources: credits=-600
fireTurretXAtGround: 1
fireTurretXAtGround_withOffset:0,0
fireTurretXAtGround_withProjectile: 1

[hiddenAction_AI矿坑受袭援护]
autoTriggerOnEvent: tookDamage
autoTrigger: if self.globalTeamTags(includes='AI系统') and eventSource!=nullUnit
takeResources: hp=0
takeResources_includeUnitsWithinRange: 850
takeResources_includeUnitsWithinRange_team: own
takeResources_excludeUnitsWithoutTags: units
takeResources_maxUnits: 16
takeResources_triggerActionForEach: AI矿坑发送援护
takeResources_searchOnly: true

[hiddenAction_AI矿坑发送援护]
requireConditional: if thisActionTarget!=self and thisActionTarget.readUnitMemory("建筑", type='boolean')==false
sendMessageTo: thisActionTarget
sendMessageWithTags: AIGroundHelp

[graphics]
total_frames: 1

image:        虫矿.png
image_wreak:  NONE

imageScale: 1.3

#AUTO
image_shadow: NONE
shadowOffsetX:1
shadowOffsetY:1

showEnergyBar: false

animation_idle_start: 0
animation_idle_end: 0
animation_idle_speed: 100
animation_idle_scale_start:1
animation_idle_scale_end:1.05
animation_idle_pingPong: true


[attack]
canAttack: true
canAttackFlyingUnits: false
canAttackLandUnits:   false
canAttackUnderwaterUnits: false

turretSize: 20
turretTurnSpeed: 3

maxAttackRange: 150
shootDelay: 50

[turret_1]
x:0
y:0

[projectile_1]
tags= T-projectile
life: 50
speed: 1000

image: null.png
deflectionPower: -1
flameWeapon: true

targetGround:true
targetGroundSpread: 150

areaDamage: 0
areaRadius: 0

explodeEffect:NONE
spawnUnit:虫塔(gridAlign=true, addResources=野性:1)

[projectile_2]
tags= T-projectile
areaDamage:-5
areaRadius:150
areaDamageNoFalloff:true
areaHitAirAndLandAtSameTime:true
areaHitUnderwaterAlways:true
life:50
instant: true
targetGround:true
friendlyFire:only-ignoreEnemy
mutator1_ifUnitWithTags: 中立资源
mutator1_areaDamageMultiplier: 0
explodeEffect:NONE

[resource_野性]
displayName: 野性


[global_resource_缺失母巢]
hidden: true
displayName: 缺失母巢
displayColor: #DD36E800
priority: 0.8

[movement]
movementType: NONE
moveSpeed: 0
moveAccelerationSpeed: 0.01
moveDecelerationSpeed: 0.01

maxTurnSpeed: 0
turnAcceleration: 0.1

[ai]
buildPriority:1.0
recommendedInEachBasePriorityIfUnmet:0.55
recommendedInEachBaseNum:2
noneInBaseExtraPriority:0.43
maxEachBase:99
ai_upgradePriority:1
upgradedFrom:虫族资源抽取器T3

useAsBuilder: false


#————联动-未来科技:皎红————

@global JiaohongYanli: (self.globalTeamTags(includes='衍黎') and self.globalTeamTags(includes='皎红'))

[hiddenAction_虚红感染区]
autoTrigger: if ${JiaohongYanli} and not self.tags(includes='虚红感染区')
temporarilyAddTags: 虚红感染区

[hiddenAction_虚红感染雾]
autoTrigger: if numberOfUnitsInTeam(withTag='虚红感染区', withinRange=600)<3 and ${JiaohongYanli}
spawnEffects: 感染*2

[effect_感染]
priority: verylow
life: 300
fadeInTime: 30
image: fog.png
color:#ff0000
scaleFrom:2
scaleTo:2.5
attachedToUnit:false
drawUnderUnits: true
alpha:0.1
atmospheric: true
ySpeedAbsolute:-0.2
xSpeedRelativeRandom:0.1
delayedStartTimerRandom:60
hSpeed:0.3
hSpeedRandom:0.1
dirSpeedRandom: 0.1
dirOffsetRandom: 180
xOffsetRelativeRandom:420
yOffsetRelativeRandom:420


[template_提取目标]
takeResources_includeUnitsWithinRange: 600
takeResources_includeUnitsWithinRange_team: own
takeResources_excludeUnitsWithoutTags: units
takeResources_discardCollected: true
takeResources_maxUnits: 9999

[template_提取目标2]
@copyFromSection: template_提取目标
autoTrigger: if numberOfUnitsInTeam(withTag="units", greaterThan=0, withinRange=${section.takeResources_includeUnitsWithinRange}) and ${JiaohongYanli}


[hiddenAction_虚红感染附中检测]
@copyFromSection: template_提取目标2
autoTriggerOnEvent: newMessage(withTag='虚红感染更新')
autoTrigger: if numberOfUnitsInTeam(withTag="units", greaterThan=0, withinRange=${section.takeResources_includeUnitsWithinRange}) and ${JiaohongYanli} and numberOfUnitsInTeam(withTag='虚红感染附停系统激活')<1
requireConditional: if numberOfUnitsInTeam(withTag="units", greaterThan=0, withinRange=${section.takeResources_includeUnitsWithinRange}) and ${JiaohongYanli} and numberOfUnitsInTeam(withTag='虚红感染附停系统激活')<1
takeResources: hp=0
takeResources_excludeUnitsWithTheseResources: 虚红感染附中=10
takeResources_triggerActionForEach: 虚红感染附中

[hiddenAction_虚红感染附中]
requireConditional: if thisActionTarget.resource.虚红感染附停<1
takeResources: 虚红感染附中=-2, 虚红感染附停=-1
takeResources_includeReference: thisActionTarget
takeResources_discardCollected: true
sendMessageTo: globalSearchForFirstUnit(withTag='单位系统', relation='own')
sendMessageWithTags: 虚红感染附停激活

fireTurretXAtGround: magic
fireTurretXAtGround_withProjectile: 虚红感染特效
fireTurretXAtGround_withTarget: thisActionTarget.getOffsetAbsolute(y=-thisActionTarget.height)


[hiddenAction_虚红感染附加检测]
@copyFromSection: template_提取目标2
takeResources: hp=0
takeResources_excludeUnitsWithTheseResources: 虚红感染=2
takeResources_triggerActionForEach: 虚红感染时间

[hiddenAction_虚红感染时间]
requireConditional: if thisActionTarget.resource.虚红感染附中>=10
takeResources: 虚红感染=-1
takeResources_includeReference: thisActionTarget
takeResources_discardCollected: true


[hiddenAction_虚红感染负面检测]
@copyFromSection: template_提取目标2
takeResources: hp=0
takeResources_triggerActionForEach: 虚红感染负面恢复

[hiddenAction_虚红感染负面恢复]
requireConditional: if thisActionTarget.resource.虚红感染负面状态>=1
takeResources: 虚红感染负面状态=1, 负虚红感染=1
takeResources_includeReference: thisActionTarget
takeResources_discardCollected: true

fireTurretXAtGround: magic
fireTurretXAtGround_withProjectile: 虚红感染特效2
fireTurretXAtGround_withTarget: thisActionTarget.getOffsetAbsolute(y=-thisActionTarget.height)


[resource_虚红感染附中]
displayName: 虚红感染附中
hidden: true

[resource_虚红感染附停]
displayName: 虚红感染附停
hidden: true

[resource_虚红感染]
displayName: 虚红感染
hidden: true

[resource_虚红感染负面状态]
displayName: 虚红感染负面状态
hidden: true

[resource_负虚红感染]
displayName: 负虚红感染
hidden: true


[turret_magic]
x: 0
y: 0
invisible: true
canShoot: false

[projectile_虚红感染特效]
directDamage: 0
invisible: true
life: 10
instant: true
targetGround_includeTargetHeight: true
explodeEffect: 虚红感染标, 虚红感染光, 虚红感染散

[projectile_虚红感染特效2]
@copyFromSection: projectile_虚红感染特效
explodeEffect: 虚红感染标, 弱虚红感染光, 弱虚红感染散


[effect_虚红感染标]
priority: low
life: 25
fadeInTime: 2
scaleFrom: 0.2
scaleTo: 0.25
alpha: 0.6
image: 皎红icon.png
attachedToUnit: true
alwayStartDirAtZero: true

[effect_虚红感染光]
priority: low
life: 30
scaleFrom: 1.3
scaleTo: 2.6
alpha: 1
image: SHARED:light_50.png
color: #FF0000
attachedToUnit: true
dirSpeedRandom: 3
dirOffsetRandom: 180

[effect_虚红感染散]
priority: low
life: 160
fadeOut: true
fadeInTime: 5
scaleFrom: 0.08
scaleTo: 0.2
alpha: 0.4
image: 红曜散裂.png
color: #FF0000
attachedToUnit: true

[effect_弱虚红感染光]
@copyFromSection: effect_虚红感染光
alpha: 0.8

[effect_弱虚红感染散]
@copyFromSection: effect_虚红感染散
life: 80
scaleTo: 0.16


[arm_1]
x: 0
y: 0
image_end: SHARED:blank.png
spinRate: 0.1

[arm_2]
@copyFromSection: arm_1
spinRate: 0.3

[arm_3]
@copyFromSection: arm_1
spinRate: -0.01

[decal_虚红感染区]
isVisible: if numberOfUnitsInTeam(withTag='虚红感染区', withinRange=600)<20 and ${JiaohongYanli}
alwaysStartHeightAtZero: true
layer: shadow
image: 红光圈2.png
basePositionFromLegEnd: arm1
imageScale: 2.7
alpha: 0.05

[decal_感染显示圈]
isVisible: if numberOfUnitsInTeam(withTag='虚红感染区', withinRange=60)<3 and ${JiaohongYanli}
alwaysStartHeightAtZero: true
alwaysStartDirAtZero: true
layer: beforeUI
image: 红范围圈1200.png
imageScale: ${600/600}
alpha: 0.4
onlyWhenSelectedByAnyPlayer: true

[decal_感染红区]
isVisible: if numberOfUnitsInTeam(withTag='虚红感染区', withinRange=600)<15 and ${JiaohongYanli}
alwaysStartHeightAtZero: true
alwaysStartDirAtZero: true
layer: beforeUI
image: 红范围底.png
imageScale: ${600/600}
alpha: 0.05 / max( (numberOfUnitsInTeam(withTag='虚红感染区', withinRange=600) /2), 1 )

[decal_感染环圈]
@copyFromSection: decal_虚红感染区
isVisible: if numberOfUnitsInTeam(withTag='虚红感染区', withinRange=600)<3 and ${JiaohongYanli} and not self.globalTeamTags(includes='关闭感染区高级效果')
basePositionFromLegEnd: arm2
image: 红外光圈2.png
imageScale: ${2.7 * 0.73}

[decal_黑感染环圈]
@copyFromSection: decal_感染环圈
image: 黑红外光圈2.png
dirOffset: 60

[decal_感染裂面]
isVisible: if numberOfUnitsInTeam(withTag='虚红感染区', withinRange=600)<4 and ${JiaohongYanli} and not self.globalTeamTags(includes='关闭感染区高级效果')
alwaysStartHeightAtZero: true
layer: shadow
image: 红散裂.png
imageScale: ${2.7 * 0.15} * (0.95 + cos( ${timer_10s} * 360 - ${b}) * 0.05)
basePosition: getOffsetRelative(x=0, y=0, dirOffset=self.timeAlive-self.dir)
onlyWithZoomLevelOrMore: 0.7

@define timer_10s: ((self.timeAlive() % 10) / 10)
alpha: 0.05+cos( ${timer_10s} * 360 - ${b}) * 0.04
@define b: 0

[decal_感染裂面2]
@copyFromSection: decal_感染裂面
imageScale: ${2.7 * 0.2} * (0.95 + cos( ${timer_10s} * 360 - ${b}) * 0.05)
@define b: 72

[decal_感染裂面3]
@copyFromSection: decal_感染裂面
imageScale: ${2.7 * 0.3} * (0.95 + cos( ${timer_10s} * 360 - ${b}) * 0.05)
@define b: 144

[decal_感染裂面4]
@copyFromSection: decal_感染裂面
imageScale: ${2.7 * 0.45} * (0.95 + cos( ${timer_10s} * 360 - ${b}) * 0.05)
alpha: 0.04+cos( ${timer_10s} * 360 - ${b}) * 0.03
@define b: 216

[decal_感染裂面5]
@copyFromSection: decal_感染裂面
imageScale: ${2.7 * 0.65} * (0.95 + cos( ${timer_10s} * 360 - ${b}) * 0.05)
alpha: 0.04+cos( ${timer_10s} * 360 - ${b}) * 0.03
@define b: 288


[decal_感染缠乱线]
isVisible: if numberOfUnitsInTeam(withTag='虚红感染区', withinRange=600)<3 and ${JiaohongYanli} and not self.globalTeamTags(includes='关闭感染区高级效果')
alwaysStartHeightAtZero: true
layer: shadow
image: 红缠乱线.png
imageScale: ${2.7 * 0.5} * (0.8 + cos( ${timer_20s} * 360 - ${b}) * 0.2)
basePosition: getOffsetRelative(x=0, y=0, dirOffset=-self.timeAlive*2 -self.dir)
onlyWithZoomLevelOrMore: 0.5

@define timer_20s: ((self.timeAlive() % 20) / 20)
alpha: 0.35+cos( ${timer_20s} * 360 - ${b}) * 0.25
@define b: 0

[decal_感染缠乱线2]
@copyFromSection: decal_感染缠乱线
dirOffset: 90
@define b: 90

[decal_感染缠乱线3]
@copyFromSection: decal_感染缠乱线
dirOffset: 180
@define b: 180

[decal_感染缠乱线4]
@copyFromSection: decal_感染缠乱线
dirOffset: 270
@define b: 270

[decal_内感染缠乱线]
@copyFromSection: decal_感染缠乱线
isVisible: if numberOfUnitsInTeam(withTag='虚红感染区', withinRange=600)<2 and ${JiaohongYanli} and not self.globalTeamTags(includes='关闭感染区高级效果')
imageScale: ${2.7 * 0.5} * (0.4 + cos( ${timer_20s} * 360 - ${b}) * 0.2)
alpha: 0.45+sin( ${timer_20s} * 360 - ${b}) * 0.25
dirOffset: 45
@define b: 45

[decal_内感染缠乱线2]
@copyFromSection: decal_内感染缠乱线
dirOffset: 135
@define b: 135

[decal_内感染缠乱线3]
@copyFromSection: decal_内感染缠乱线
dirOffset: 225
@define b: 225

[decal_内感染缠乱线4]
@copyFromSection: decal_内感染缠乱线
dirOffset: 315
@define b: 315


